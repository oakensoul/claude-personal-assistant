---
title: "Technical Specification - Issue #37"
issue: 37
version: "1.0"
date: "2025-10-06"
status: "ready_for_review"
---

# Technical Specification: Archive Global Agents and Commands

## Architecture Overview

Create version-controlled template baseline by archiving agents/commands from `~/.claude/` to `templates/` directory with path variable substitution for three-repo portability (AIDA framework, dotfiles, dotfiles-private). Templates processed at install-time by `install.sh` using shell-based variable substitution engine. Architecture separates immutable templates (source of truth) from generated user configuration (runtime state).

**Key Principle**: Create NEW generic templates (not archive user content) to protect privacy - knowledge directories contain learned patterns from real usage.

**Processing Flow**: `templates/*.template` → `install.sh` (variable substitution) → `~/.claude/*.md` (resolved paths)

## Technical Decisions

### TD-1: Template Philosophy

- **Decision**: Create NEW generic templates (not direct archives of user content)
- **Rationale**: Knowledge directories contain learned patterns, usernames in paths, user-specific examples - privacy violation risk HIGH
- **Alternatives**: Archive with scrubbing (medium risk), archive as-is (rejected - critical privacy risk)
- **Trade-offs**: Higher effort (+6-8 hours) to genericize content vs zero privacy risk

### TD-2: Knowledge Directory Strategy

- **Decision**: Empty structure with README examples (Option B from PRD OQ-2)
- **Rationale**: Knowledge is user-generated by definition, contains learned behaviors - scrubbing unreliable
- **Alternatives**: Full scrubbed content (high manual effort + risk), exclude entirely (users don't see structure)
- **Trade-offs**: Less useful examples (-) but zero privacy risk (+), clear template purpose (+)

### TD-3: Variable Substitution Timing

- **Decision**: Install-time substitution (not runtime)
- **Rationale**: Simpler, faster, more portable - resolved paths stored in `~/.claude/`
- **Alternatives**: Runtime expansion (complex, performance overhead), manual (error-prone)
- **Trade-offs**: Can't change paths post-install (-) but no runtime overhead (+)

### TD-4: Template Processing Tool

- **Decision**: Pure shell substitution (Bash 3.2 compatible)
- **Rationale**: No external dependencies, macOS compatible, sufficient for simple variable replacement
- **Alternatives**: envsubst (requires brew install), sed (complex escaping), awk (overkill)
- **Trade-offs**: Limited functionality (-) but zero dependencies (+), universal compatibility (+)

### TD-5: File Extension Convention

- **Decision**: `.template` extension ONLY for files needing variable substitution
- **Rationale**: Most agents don't reference paths (exact copies), only commands need processing
- **Alternatives**: All files as .template (unnecessary processing), no extension (ambiguous)
- **Trade-offs**: 8 commands as .template, 22+ agents as exact copies

### TD-6: Validation Enforcement

- **Decision**: Mandatory pre-commit hook + blocking CI check for templates/
- **Rationale**: Privacy violations non-negotiable for public-facing templates
- **Alternatives**: Warn only (unsafe), manual review only (error-prone)
- **Trade-offs**: Strict enforcement may block legitimate changes (-) but prevents privacy leaks (+)

### TD-7: Specialized Agent Location

- **Decision**: Phase 2 - defer to separate issue, archive to `templates/agents/specialized/`
- **Rationale**: Validate approach with 6 core agents first, reduce initial scope, learn before scaling
- **Alternatives**: All agents Phase 1 (too large), flat directory (harder categorization later)
- **Trade-offs**: Delayed completeness (-) but reduced risk (+), cleaner MVP (+)

### TD-8: Scope Boundary

- **Decision**: Archive templates only - defer install.sh processing to separate issue
- **Rationale**: PRD explicitly defers install.sh enhancements, focus on template quality
- **Alternatives**: Include install.sh changes (scope creep), document assumptions only
- **Trade-offs**: Templates not immediately usable (-) but clean scope boundary (+)

## Implementation Plan

### Components to Build/Modify

**NEW: `templates/` Directory Structure**

```text
templates/
├── README.md                      # Variable reference, installation process
├── commands/
│   ├── README.md                  # Command catalog with variable usage
│   ├── create-agent.md.template
│   ├── create-command.md.template
│   ├── create-issue.md.template
│   ├── publish-issue.md.template
│   ├── expert-analysis.md.template
│   ├── generate-docs.md.template
│   ├── track-time.md.template
│   └── workflow-init.md.template
└── agents/
    ├── README.md                  # Agent structure, categories
    ├── claude-agent-manager/
    │   ├── claude-agent-manager.md
    │   └── knowledge/
    │       ├── README.md          # Structure explanation + examples
    │       ├── core-concepts/.gitkeep
    │       ├── patterns/.gitkeep
    │       └── decisions/.gitkeep
    ├── code-reviewer/             # Similar structure
    ├── devops-engineer/
    ├── product-manager/
    ├── tech-lead/
    └── technical-writer/
```

**NEW: `scripts/validate-templates.sh`**

- Privacy scrubbing validation (usernames, absolute paths, PII)
- Variable syntax checking (`${VAR}` format)
- Frontmatter YAML validation
- Knowledge directory structure validation
- Cross-reference integrity checks

**NEW: `.github/workflows/validate-templates.yml`**

- Trigger on PR/push to templates/
- Run validation script (blocking)
- Privacy scan (gitleaks already handles secrets)
- Test variable resolution in isolated environment

**MODIFY: `.pre-commit-config.yaml`**

```yaml
- repo: local
  hooks:
    - id: validate-templates-privacy
      name: Validate templates privacy compliance
      entry: scripts/validate-templates.sh
      language: system
      files: ^templates/
      pass_filenames: false

    - id: no-absolute-paths-in-templates
      name: Check for absolute paths
      entry: '/Users/[^/]+/'
      language: pygrep
      files: ^templates/
      types: [text]
```

#### NEW: Documentation

- `templates/README.md` - System overview, variable reference, installation
- `templates/commands/README.md` - Command catalog, usage patterns
- `templates/agents/README.md` - Agent structure, knowledge organization

### Dependencies

**External Dependencies**: NONE (pure shell, standard Unix tools)

- grep, find, sed (POSIX standard)
- yamllint (already in pre-commit)
- markdownlint (already in pre-commit)
- gitleaks (already in pre-commit)

**Internal Components Affected**:

- install.sh (future integration - separate issue)
- Pre-commit hooks (add template validation)
- CI/CD pipeline (add template workflow)
- Documentation (add template system docs)

### Integration Points

**Three-Repo Integration Model**:

1. **AIDA Framework (claude-personal-assistant)**: Source of truth templates
2. **Dotfiles (public)**: Optional AIDA integration via stow or reference
3. **Dotfiles-Private**: Private overlay stows over public configs

**Integration Flow**:

```bash
# User installs AIDA (processes templates)
~/.aida/install.sh  # Copies templates/ → ~/.claude/ with variable substitution

# User installs dotfiles (detects AIDA, skips ~/.claude/)
~/dotfiles/install.sh

# User overlays private configs
cd ~/dotfiles-private && stow aida  # Private commands/agents overlay
```

**Variable Resolution**:

- `${PROJECT_ROOT}` - Git root (or $HOME if not in repo)
- `${CLAUDE_CONFIG_DIR}` - Always `~/.claude`
- `${AIDA_HOME}` - Always `~/.aida`

## Technical Risks & Mitigations

### Risk: Privacy Leak (HIGH Impact, MEDIUM Probability)

- **Description**: Accidental commit of usernames, learned patterns, PII to public repo
- **Impact**: Privacy violation, reputational damage, potential security exposure
- **Mitigation**:
  - Create NEW generic templates (not archive user content)
  - Three-layer validation: automated pattern detection, pre-commit hook, CI blocking
  - Empty knowledge structure (no learned content)
  - Mandatory manual review before merge
- **Detection**: Automated checks for `/Users/`, email patterns, Owner fields in knowledge

### Risk: Broken Variable Substitution (HIGH Impact, MEDIUM Probability)

- **Description**: Variables not resolving correctly, commands fail on fresh install
- **Impact**: Framework unusable for new users, broken installation experience
- **Mitigation**:
  - Validation script checks for unresolved `${VARS}`
  - Test on fresh system (different user account)
  - CI test-installation workflow validates templates
  - Integration test after each command archived
- **Detection**: Fresh install test, grep for `${` in generated files

### Risk: Incomplete Path Replacement (MEDIUM Impact, MEDIUM Probability)

- **Description**: Missed absolute paths in commands, hardcoded /Users/ references
- **Impact**: Commands fail on other systems, username exposure
- **Mitigation**:
  - Automated scan for `/Users/`, `/home/`, `/Developer/` patterns
  - Pre-commit hook blocks absolute paths
  - Per-command validation during archival
- **Detection**: Regex patterns in validation script

### Risk: Knowledge Directory Privacy (HIGH Impact, LOW Probability)

- **Description**: User-specific learned patterns committed to public repo
- **Impact**: Privacy violation, proprietary information exposure
- **Mitigation**:
  - Empty structure approach (no content archival)
  - Manual review of any included examples
  - Scrubbing checklist for each agent
- **Detection**: Manual inspection, automated Owner field detection

### Risk: Frontmatter Corruption (MEDIUM Impact, LOW Probability)

- **Description**: YAML parsing breaks during copy, agents not discoverable
- **Impact**: Agents/commands don't load, installation incomplete
- **Mitigation**:
  - yamllint validation in pre-commit
  - Exact copy (no transformation) for agents
  - Preserve indentation and quoting
- **Detection**: yamllint --strict, test agent loading

### Risk: Cross-Reference Breakage (LOW Impact, MEDIUM Probability)

- **Description**: Commands reference non-existent agents, knowledge links broken
- **Impact**: Confusing documentation, missing dependencies
- **Mitigation**:
  - Validate agent invocations in commands
  - Check knowledge/ cross-references
  - Document agent dependencies in README
- **Detection**: Automated link checking, manual review

### Risk: Template-User Config Drift (MEDIUM Impact, HIGH Probability)

- **Description**: Templates become outdated, new installs get stale configs
- **Impact**: Users don't get latest features/fixes
- **Mitigation**:
  - Document manual sync workflow in README
  - Accept drift for v0.1 (premature optimization)
  - Version templates with framework (same VERSION file)
- **Detection**: Periodic review, user reports

### Risk: GNU Stow Conflicts (LOW Impact, MEDIUM Probability)

- **Description**: Stow refuses to link due to existing ~/.claude/ files
- **Impact**: Dotfiles integration fails, manual intervention needed
- **Mitigation**:
  - Document installation order (AIDA first OR dotfiles first, both work)
  - Dotfiles detect existing ~/.claude/ and skip
  - Clear error messages with remediation steps
- **Detection**: Test stow integration in dotfiles repo

## Testing Strategy

### Unit Testing

**Validation Functions** (in `scripts/validate-templates.sh`):

- `check_absolute_paths()` - Detect /Users/, /home/ patterns
- `check_usernames()` - Detect actual username in content
- `check_pii()` - Email, phone, SSN patterns
- `validate_yaml()` - Frontmatter integrity
- `validate_variables()` - Only approved variables used
- `count_knowledge()` - index.md knowledge_count accurate

**Test Execution**:

```bash
# Run validation on templates/
./scripts/validate-templates.sh

# Test variable substitution (mock environment)
PROJECT_ROOT=/test/repo ./scripts/test-variable-substitution.sh
```

### Integration Testing

**Fresh Install Validation**:

```bash
# Test on clean system (Docker or test user account)
./install.sh --assistant-name test --personality jarvis
test -f ~/.claude/commands/create-issue.md
grep -q '${PROJECT_ROOT}' ~/.claude/commands/create-issue.md && exit 1  # Fail if unresolved
```

**Cross-Platform Testing**:

- macOS (Bash 3.2 and Bash 5.x via Homebrew)
- Linux (Ubuntu 22/24, Debian 12) via existing CI
- Test-installation.yml already covers multiple platforms

**Three-Repo Integration** (future):

- Install AIDA → Install dotfiles → Verify coexistence
- Install dotfiles → Install AIDA → Verify detection
- Overlay dotfiles-private → Verify private configs override public

### Edge Cases to Cover

**Path Substitution**:

- Paths with spaces: `/Users/foo bar/Developer/`
- Symbolic links in ~/.claude/ (dev mode)
- Variables in YAML frontmatter (ensure no breakage)
- Nested variables: `${${VAR}_PATH}` (should fail validation)
- Escaped variables: `\${NOT_A_VAR}` (preserve literal)

**Privacy Scrubbing**:

- Username variants: `/Users/oakensoul`, `~oakensoul`, `oakensoul@`
- Email obfuscation: `user [at] domain [dot] com`
- Code examples vs actual data (distinguish context)
- Company/project names in knowledge files

**Knowledge Directory**:

- Empty knowledge/ (zero files)
- Missing subdirectories (core-concepts/, patterns/, decisions/)
- knowledge_count mismatch in index.md
- Broken internal links in knowledge files

**File System**:

- Read-only template files (should fail gracefully)
- Case-sensitive vs case-insensitive filesystems
- Long file paths (>255 chars) - unlikely but possible
- Concurrent installations (race conditions)

### Validation Checklist

**Pre-Implementation**:

- [ ] Audit ~/.claude/ for privacy violations (establish baseline)
- [ ] Catalog absolute paths requiring substitution
- [ ] Survey knowledge/ directories for user-specific content
- [ ] Document cross-references between commands/agents

**During Implementation**:

- [ ] Each command validated for variable substitution correctness
- [ ] Each agent reviewed for privacy compliance
- [ ] Knowledge directories use empty structure with examples
- [ ] Frontmatter validated with yamllint

**Post-Implementation**:

- [ ] Privacy scan passes (zero violations)
- [ ] Fresh install test succeeds (clean VM)
- [ ] Cross-platform test passes (macOS + Linux)
- [ ] Pre-commit hooks work correctly
- [ ] CI validation workflow passes

**Pre-Merge**:

- [ ] Manual code review (visual inspection)
- [ ] Spot check installation (2 agents, 3 commands)
- [ ] Documentation review (README accuracy)
- [ ] All automated checks green

## Open Technical Questions

### OTQ-1: Knowledge Directory Per-Agent Decision (BLOCKER)

- **Question**: Which core agents should have example knowledge files vs empty structure?
- **Context**: Some agents (code-reviewer) have generic patterns worth including, others (tech-lead) are user-specific
- **Investigation**: Review each of 6 core agents, categorize knowledge as generic vs learned
- **Decision Needed**: Per-agent basis during archival
- **Default**: Empty structure for all (safest)

### OTQ-2: Variable Resolution Error Handling

- **Question**: What if PROJECT_ROOT undefined (not in git repo)?
- **Current Approach**: Fallback to `$HOME`
- **Alternative**: Fail install with clear error message
- **Decision Needed**: Before install.sh enhancement (separate issue)

### OTQ-3: Dev Mode Template Processing

- **Question**: Should dev mode process templates or symlink directly?
- **Context**: Dev mode uses symlinks to development directory for live editing
- **Options**: (A) Skip template processing in dev mode, (B) Process templates even in dev mode
- **Recommendation**: Skip processing (symlinks point to .template files directly)
- **Decision Needed**: During install.sh enhancement

### OTQ-4: Update Workflow for Existing Users

- **Question**: How do users update templates after initial install?
- **Options**: (A) Re-run install.sh (overwrites), (B) Selective update flag, (C) Manual sync
- **Recommendation**: Option C for v0.1 (document manual process), Option B for v0.2
- **Decision Needed**: For documentation (out of scope for implementation)

### OTQ-5: Private Command Override Mechanism

- **Question**: How do users override public commands with private versions?
- **Options**: (A) Stow overlay (dotfiles-private/.claude/), (B) Symlink replacement, (C) Environment variable
- **Recommendation**: Option A (consistent with dotfiles approach)
- **Decision Needed**: Document in dotfiles integration guide (not AIDA repo)

## Effort Estimate

### Overall Complexity: MEDIUM (M)

**Total Estimated Effort**: 18-24 hours (Phase 1 only - 6 core agents + 8 commands)

### Breakdown by Component

**Privacy Scrubbing & Validation** (6-8 hours) - Highest effort:

- Write `scripts/validate-templates.sh`: 2-3 hours
- Create pre-commit hooks: 1-2 hours
- Manual review of 6 core agents: 2-3 hours
- Testing validation script: 1 hour

**Command Archival** (3-4 hours):

- Create .template files with variable substitution: 2 hours
- Test variable resolution: 1 hour
- Validate all path references replaced: 1 hour

**Agent Archival** (4-6 hours):

- Copy 6 core agent definitions: 1 hour
- Create empty knowledge structures: 1-2 hours
- Write knowledge/ README examples: 2-3 hours

**Documentation** (3-4 hours):

- `templates/README.md` with variable reference: 1.5-2 hours
- `templates/commands/README.md` catalog: 1 hour
- `templates/agents/README.md` structure guide: 0.5-1 hour

**Testing & Validation** (2-3 hours):

- Fresh install test on clean system: 1 hour
- Cross-platform validation (leverage CI): 1 hour
- Manual spot checks: 0.5-1 hour

### Key Effort Drivers

**HIGH effort**:

1. Privacy scrubbing automation and validation (30% of effort)
2. Manual review of knowledge directories (25% of effort)
3. Documentation with comprehensive examples (20% of effort)

**MEDIUM effort**:

4. Variable substitution implementation (15% of effort)
5. Testing across environments (10% of effort)

### Recommended Breakdown

**Session 1** (4-6 hours): Validation infrastructure

- Create validation script
- Add pre-commit hooks
- Audit existing content for privacy issues
- Set up testing environment

**Session 2** (6-8 hours): Core archival

- Archive 8 commands with variable substitution
- Archive 6 core agents with empty knowledge structure
- Create knowledge/ README examples

**Session 3** (4-6 hours): Documentation and testing

- Write 3 comprehensive README files
- Fresh install testing
- CI workflow configuration
- Manual review and iteration

**Session 4** (2-4 hours): Final validation and cleanup

- Address any validation failures
- Manual spot checks
- Documentation review
- Prepare for merge

---

**Next Steps**:

1. Answer OTQ-1 (knowledge directory strategy per agent)
2. Create validation script (blocks all other work)
3. Audit existing ~/.claude/ content for privacy violations
4. Begin Phase 1 archival (commands first, then agents)
5. Document assumptions for install.sh enhancement (separate issue)
