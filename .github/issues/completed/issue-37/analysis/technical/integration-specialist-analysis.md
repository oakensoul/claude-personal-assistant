---
title: "Integration Specialist Technical Analysis - Issue #37"
issue: 37
agent: "integration-specialist"
analysis_type: "technical"
created: "2025-10-06"
status: "draft"
---

# Integration Specialist Technical Analysis: Archive Agents and Commands

## Executive Summary

**Scope**: Technical implementation analysis for archiving 14 commands and 22 agents from `~/.claude/` to `templates/` with path variable substitution for three-repo ecosystem portability.

**Key Finding**: Current install.sh has NO template processing capability. This must be added to support `.template` file substitution.

**Complexity**: **Medium (M)** - Requires new install.sh functionality, variable substitution logic, and cross-repo testing.

**Risk Level**: Medium - Path substitution errors could break commands across all installation methods.

## 1. Implementation Approach

### Integration Architecture

**Three-Layer Distribution Model**:

```text
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: AIDA Framework Repository (claude-personal-assistant)│
│ templates/                                                   │
│ ├── commands/*.md.template  ← Source of truth              │
│ └── agents/*/               ← With knowledge/ dirs          │
└─────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────────────────────────────────┐
        │ install.sh processes .template → ~/.claude/     │
        │ Variable substitution at install time           │
        └─────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: User Runtime (generated by install.sh)             │
│ ~/.claude/commands/*.md     ← Variables resolved            │
│ ~/.claude/agents/*/         ← Ready to use                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────────────────────────────────┐
        │ Optional: Dotfiles stow integration             │
        │ ~/dotfiles/aida/.claude/                        │
        └─────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: Private Overlay (dotfiles-private)                 │
│ ~/dotfiles-private/aida/.claude/ ← Overrides public         │
└─────────────────────────────────────────────────────────────┘
```

### install.sh Modifications Required

**Current State** (v0.1.2):

- Copies repository to `~/.aida/` (or symlinks in dev mode)
- Creates `~/.claude/` directories
- Generates `~/CLAUDE.md`
- NO template processing

**Required Changes**:

```bash
# NEW FUNCTION: Process template files
process_templates() {
    local source_dir="$1"
    local target_dir="$2"

    print_message "info" "Processing templates in ${source_dir}..."

    # Find all .template files
    find "$source_dir" -name "*.template" -type f | while read -r template; do
        # Calculate target path (remove .template extension)
        local relative_path="${template#$source_dir/}"
        local target_file="${target_dir}/${relative_path%.template}"

        # Ensure target directory exists
        mkdir -p "$(dirname "$target_file")"

        # Process template with variable substitution
        substitute_variables "$template" "$target_file"

        print_message "success" "Processed: ${relative_path}"
    done
}

# NEW FUNCTION: Variable substitution
substitute_variables() {
    local source_file="$1"
    local target_file="$2"

    # Detect project root (git root if in project, else ~/)
    local project_root
    project_root=$(git rev-parse --show-toplevel 2>/dev/null || echo "$HOME")

    # Variable map
    local -A variables=(
        [PROJECT_ROOT]="$project_root"
        [CLAUDE_CONFIG_DIR]="${CLAUDE_DIR}"
        [AIDA_HOME]="${AIDA_DIR}"
        [HOME]="$HOME"
    )

    # Read template, substitute variables, write to target
    local content
    content=$(cat "$source_file")

    for var in "${!variables[@]}"; do
        content="${content//\$\{${var}\}/${variables[$var]}}"
    done

    echo "$content" > "$target_file"
    chmod 644 "$target_file"
}

# NEW FUNCTION: Copy non-template files
copy_templates() {
    local source_dir="$1"
    local target_dir="$2"

    print_message "info" "Copying template files to ${target_dir}..."

    # Copy all non-.template files (agents, knowledge/, READMEs)
    rsync -av \
        --exclude='*.template' \
        --include='*/' \
        --include='*.md' \
        --include='*.yaml' \
        --exclude='*' \
        "${source_dir}/" "${target_dir}/"

    print_message "success" "Template files copied"
}

# MODIFY: create_directories() to process templates
create_directories() {
    # ... existing directory creation ...

    # NEW: Process templates from repository
    if [[ "$DEV_MODE" == true ]]; then
        # In dev mode, process from symlinked location
        process_templates "${AIDA_DIR}/templates" "${CLAUDE_DIR}"
    else
        # In normal mode, process from copied location
        process_templates "${AIDA_DIR}/templates" "${CLAUDE_DIR}"
    fi

    # NEW: Copy non-template files
    copy_templates "${AIDA_DIR}/templates" "${CLAUDE_DIR}"
}
```

### Stow Package Structure

**Location**: `~/dotfiles/aida/` (dotfiles repository)

**Structure**:

```text
dotfiles/
└── aida/                       # Stow package
    ├── .claude/
    │   ├── commands/           # Symlink or copy from ~/.aida/templates/commands/
    │   └── agents/             # Symlink or copy from ~/.aida/templates/agents/
    └── README.md               # Integration docs

# Strategy 1: Reference AIDA templates (preferred)
# Stow package references ~/.aida/templates/ (requires AIDA installed first)

# Strategy 2: Bundle templates in dotfiles (standalone)
# Stow package includes copies of templates (works without AIDA)
```

**Stow Integration Script** (in dotfiles repo):

```bash
#!/usr/bin/env bash
# dotfiles/install.sh enhancement

install_aida_integration() {
    if [[ ! -d "$HOME/.aida" ]]; then
        echo "AIDA framework not detected. Install AIDA first:"
        echo "  git clone https://github.com/oakensoul/claude-personal-assistant.git ~/.aida"
        echo "  cd ~/.aida && ./install.sh"
        return 1
    fi

    print_message "info" "Installing AIDA integration from dotfiles..."

    # Check if ~/.claude/ exists (AIDA already configured)
    if [[ -d "$HOME/.claude" ]]; then
        print_message "warning" "AIDA configuration exists, skipping stow"
        print_message "info" "To overlay dotfiles config, use: stow -t ~/.claude aida"
        return 0
    fi

    # Stow AIDA package
    stow -v aida

    print_message "success" "AIDA integration stowed"
}
```

## 2. Technical Concerns

### Cross-Repo Compatibility

**Challenge**: Templates in AIDA repo must work when:

1. Installed via `./install.sh` → `~/.claude/`
2. Stowed from dotfiles → `~/.claude/`
3. Overlayed by dotfiles-private → `~/.claude/`

**Solution**: Variable substitution at install time ensures portability.

**Test Matrix**:

| Installation Method | Template Processing | Variables Resolved | Works? |
|---------------------|---------------------|-------------------|--------|
| AIDA install.sh     | ✅ Yes              | ✅ Yes            | ✅     |
| Dotfiles stow       | ❌ No (needs impl)  | ❓ Manual         | ⚠️     |
| Private overlay     | ❌ No               | ❓ Pre-resolved   | ⚠️     |

**Recommendation**: Dotfiles should reference AIDA-processed templates, not duplicate template processing logic.

### Installation Flow Changes

**Before (v0.1.2)**:

```bash
./install.sh
→ Copy repo to ~/.aida/
→ Create ~/.claude/ directories
→ Generate ~/CLAUDE.md
✅ Done
```

**After (v0.2.0 with template processing)**:

```bash
./install.sh
→ Copy repo to ~/.aida/
→ Create ~/.claude/ directories
→ Process templates/*.template files    # NEW
→ Copy non-template files (agents/)     # NEW
→ Generate ~/CLAUDE.md
✅ Done
```

**Performance Impact**:

- Template processing adds ~1-2 seconds for 14 commands
- Negligible for user experience
- Could optimize with parallel processing (future)

### Override Mechanisms

**User Customization Strategy**:

1. **Don't modify** `~/.aida/templates/` (framework-managed)
2. **Do modify** `~/.claude/commands/` (user workspace)
3. **Overlay with** `~/dotfiles-private/aida/.claude/` (private customizations)

**Update Workflow**:

```bash
# User updates AIDA framework
cd ~/.aida && git pull

# Re-run install to update templates
./install.sh

# WARNING: This overwrites ~/.claude/commands/
# Users should backup customizations first

# Future enhancement: Selective update with merge
./install.sh --update-templates --preserve-customizations
```

**Conflict Resolution** (future):

```bash
# Detect modified files in ~/.claude/
git init ~/.claude && git add -A && git commit -m "baseline"
./install.sh --update-templates
git diff  # Show what changed
git checkout -- file.md  # Revert to template
# OR
git commit -am "Keep my customizations"
```

### Integration Risks

**Risk 1: Variable Substitution Bugs**:

- **Impact**: Commands reference wrong paths, fail to execute
- **Mitigation**: Comprehensive testing, validation script
- **Detection**: Automated tests check variable resolution

**Risk 2: Stow Conflicts**:

- **Impact**: Stow refuses to link due to existing files
- **Mitigation**: Clear installation order documentation
- **Detection**: Stow dry-run tests

**Risk 3: Template Processing Failure**:

- **Impact**: install.sh fails, incomplete installation
- **Mitigation**: Atomic operations, rollback on error
- **Detection**: Pre-commit tests validate template syntax

**Risk 4: Version Skew**:

- **Impact**: Dotfiles templates diverge from AIDA templates
- **Mitigation**: Version compatibility checks
- **Detection**: CI tests cross-repo compatibility

## 3. Dependencies & Integration

### install.sh Changes Needed

**New Functions** (add to install.sh):

1. `process_templates()` - Process .template files with variable substitution
2. `substitute_variables()` - Replace ${VAR} with actual values
3. `copy_templates()` - Copy non-template files (agents, knowledge/)
4. `validate_template_processing()` - Verify templates processed correctly

**Modified Functions**:

1. `create_directories()` - Add template processing step
2. `display_summary()` - Show count of processed templates

**New Dependencies**:

- None (uses existing bash, sed, find, rsync)

**Testing Requirements**:

- Unit tests for substitute_variables()
- Integration tests for full install flow
- Validation script for variable resolution

### Dotfiles Integration Points

**Dotfiles Repository** (public):

```text
dotfiles/
├── install.sh                  # Enhanced with AIDA detection
├── aida/                       # Stow package
│   ├── .claude/
│   │   └── README.md           # "Installed via AIDA framework"
│   └── bin/
│       └── aida-sync           # Sync templates from ~/.aida/
└── README.md                   # Documents AIDA integration
```

**Dotfiles-Private Repository**:

```text
dotfiles-private/
└── aida/                       # Private overlay
    └── .claude/
        ├── commands/
        │   └── my-private-cmd.md
        └── agents/
            └── my-private-agent/
```

**Installation Order**:

```bash
# Recommended: AIDA first, then dotfiles
cd ~/.aida && ./install.sh           # Install AIDA, process templates
cd ~/dotfiles && ./install.sh        # Detect AIDA, skip ~/.claude/
cd ~/dotfiles-private && stow aida   # Overlay private configs

# Alternative: Dotfiles first, then AIDA
cd ~/dotfiles && ./install.sh        # Install dotfiles (no AIDA yet)
cd ~/.aida && ./install.sh           # Install AIDA, process templates
cd ~/dotfiles && stow aida           # Link AIDA integration (optional)
```

### Testing Across All Three Repos

**Test Scenarios**:

```bash
# Scenario 1: AIDA standalone
./install.sh
test -f ~/.claude/commands/start-work.md
grep -q '${PROJECT_ROOT}' ~/.claude/commands/start-work.md && echo "FAIL: Variable not substituted"

# Scenario 2: AIDA + Dotfiles
./install.sh
cd ~/dotfiles && ./install.sh
test -L ~/.bashrc  # Dotfiles stowed
test -f ~/.claude/commands/start-work.md  # AIDA installed

# Scenario 3: All three repos
./install.sh
cd ~/dotfiles && ./install.sh
cd ~/dotfiles-private && stow aida
test -f ~/.claude/commands/my-private-cmd.md  # Private overlay

# Scenario 4: Variable resolution
./install.sh
actual_project_root=$(grep 'PROJECT_ROOT' ~/.claude/commands/start-work.md | head -1)
expected_project_root=$(git rev-parse --show-toplevel)
[[ "$actual_project_root" == *"$expected_project_root"* ]] || echo "FAIL: Wrong PROJECT_ROOT"
```

**CI/CD Integration** (future):

```yaml
# .github/workflows/test-installation.yml
name: Test Installation Flows
on: [push, pull_request]

jobs:
  test-aida-standalone:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: ./install.sh
      - run: test -f ~/.claude/commands/start-work.md
      - run: .github/testing/validate-templates.sh

  test-dotfiles-integration:
    runs-on: ubuntu-latest
    steps:
      - name: Install AIDA
        run: |
          git clone . ~/.aida
          cd ~/.aida && ./install.sh --assistant-name test --personality jarvis
      - name: Install dotfiles
        run: |
          git clone https://github.com/oakensoul/dotfiles.git ~/dotfiles
          cd ~/dotfiles && ./install.sh
      - run: .github/testing/validate-integration.sh
```

## 4. Effort & Complexity

### Complexity Assessment: **Medium (M)**

**Effort Breakdown**:

| Task | Effort | Complexity | Risk |
|------|--------|-----------|------|
| Archive commands/agents | 2 hours | Low | Low |
| Implement template processing | 4 hours | Medium | Medium |
| Add variable substitution | 2 hours | Low | Medium |
| Create READMEs | 2 hours | Low | Low |
| Test AIDA standalone | 1 hour | Low | Low |
| Test dotfiles integration | 2 hours | Medium | Medium |
| Test private overlay | 1 hour | Low | Low |
| Documentation | 2 hours | Low | Low |
| **Total** | **16 hours** | **Medium** | **Medium** |

**Key Effort Drivers**:

1. **Template processing logic** - New feature in install.sh (4 hours)
2. **Cross-repo testing** - Validate three installation flows (4 hours)
3. **Documentation** - READMEs explaining variables (2 hours)
4. **Archival work** - Copy/scrub 36 files (2 hours)

**Complexity Factors**:

- ✅ **Low**: Archival is straightforward file copying
- ⚠️ **Medium**: Template processing requires new install.sh logic
- ⚠️ **Medium**: Cross-repo testing has many edge cases
- ✅ **Low**: Variable substitution is simple string replacement

### Risk Areas

**High Risk**:

- Variable substitution bugs breaking commands
- Stow conflicts during dotfiles integration
- Version skew between AIDA and dotfiles templates

**Medium Risk**:

- Performance impact of template processing
- User confusion about customization workflow
- Breaking changes in future template updates

**Low Risk**:

- Privacy scrubbing (validation-specialist handles this)
- Knowledge directory size (only ~6 agents have knowledge/)

## 5. Questions & Clarifications

### Technical Questions Needing Answers

#### Q1: Template Processing Timing

- Question: Should template processing happen at install time or runtime?
- Options:
  - A) Install time (recommended) - Variables resolved once, stored in ~/.claude/
  - B) Runtime - Variables resolved every command execution
- Impact: Performance, complexity, portability
- Recommendation: Install time (simpler, faster, more portable)
- Decision needed: Before implementation

#### Q2: Variable Scope

- Question: Which variables should be supported?
- Current list:
  - `${PROJECT_ROOT}` - Git root (or $HOME if not in git repo)
  - `${CLAUDE_CONFIG_DIR}` - ~/.claude
  - `${AIDA_HOME}` - ~/.aida
  - `${HOME}` - User home
- Missing:
  - `${OBSIDIAN_VAULT_PATH}` - For future Obsidian integration
  - `${GITHUB_ORG}` - For GitHub commands
  - `${USER}` - Username
- Decision needed: Finalize variable list before archival

#### Q3: Selective Installation

- Question: Should users be able to install only specific commands/agents?
- Implementation:

  ```bash
  ./install.sh --commands create-issue,start-work --agents tech-lead
  ```

- Impact: More complex install logic, better UX
- Recommendation: Defer to v0.3 (out of scope for #37)
- Decision needed: Confirm out of scope

#### Q4: Update Strategy

- Question: How should users update templates after install?
- Options:
  - A) Re-run install.sh (overwrites ~/.claude/)
  - B) Add --update-templates flag (selective update)
  - C) Manual sync (documentation only)
- Impact: User experience, maintenance burden
- Recommendation: Option C for v0.2, Option B for v0.3
- Decision needed: Document update workflow

#### Q5: Stow Strategy

- Question: Should dotfiles bundle templates or reference AIDA?
- Options:
  - A) Reference - Dotfiles require AIDA installed first
  - B) Bundle - Dotfiles include template copies (duplication)
- Impact: Maintenance, version skew, standalone usage
- Recommendation: Option A (require AIDA first)
- Decision needed: Dotfiles repo design

### Areas Needing Investigation

#### Investigation 1: Stow .template Handling

- Scope: Test if stow handles .template extensions correctly
- Method: Create test stow package with .template files
- Risk: Stow may not process .template correctly
- Mitigation: Pre-process templates before stowing

#### Investigation 2: Performance Impact

- Scope: Measure template processing time for 14 commands
- Method: Benchmark install.sh before/after changes
- Risk: Significant slowdown (>5 seconds)
- Mitigation: Optimize with parallel processing

#### Investigation 3: Bash 3.2 Compatibility

- Scope: Verify variable substitution works on macOS Bash 3.2
- Method: Test on macOS system with default bash
- Risk: Bash 3.2 lacks features (associative arrays, etc.)
- Mitigation: Use Bash 3.2-compatible syntax

#### Investigation 4: Git Root Detection

- Scope: Test `git rev-parse --show-toplevel` in various contexts
- Method: Test in project, non-project, submodule scenarios
- Risk: Wrong PROJECT_ROOT in edge cases
- Mitigation: Fallback to $HOME if not in git repo

### Decisions to be Made

#### Decision 1: Scope of Issue #37

- Question: Does #37 include install.sh template processing implementation?
- PRD says: "Defer template installation logic to separate issue"
- Recommendation: Archive only for #37, implement processing in separate issue
- Decision needed: Confirm with product manager

#### Decision 2: .template Extension for All Commands

- Question: Should ALL commands use .template, or only those with variables?
- Options:
  - A) All commands (consistent, easier to maintain)
  - B) Only commands with variables (less processing)
- Recommendation: Option B (only commands with variables)
- Decision needed: Before archival

#### Decision 3: Knowledge Directory Variable Substitution

- Question: Do knowledge/ markdown files need variable substitution?
- Investigation needed: Check if knowledge/ files reference paths
- Recommendation: Archive without .template, add later if needed
- Decision needed: After investigation

#### Decision 4: Private Command Override Strategy

- Question: How do users override public commands with private versions?
- Options:
  - A) Stow overlay (dotfiles-private/.claude/commands/)
  - B) Symlink replacement (ln -sf private.md public.md)
  - C) Environment variable (CLAUDE_COMMANDS_DIR)
- Recommendation: Option A (stow overlay)
- Decision needed: Document in dotfiles integration guide

## Summary

**Implementation Approach**: Archive templates to `templates/` with .template extension for files needing variable substitution, implement template processing in install.sh, test across AIDA/dotfiles/dotfiles-private installation flows.

**Complexity**: Medium (16 hours effort) - New install.sh functionality, cross-repo testing, documentation.

**Key Risks**: Variable substitution bugs, stow conflicts, version skew between repos.

**Critical Dependencies**: install.sh template processing implementation (may be separate issue), dotfiles integration design decisions, validation of variable list.

**Recommendations**:

1. Archive templates in #37 (no install.sh changes)
2. Implement template processing in separate issue (#38)
3. Document installation order for three-repo system
4. Test stow integration separately in dotfiles repo

---

**Next Steps**:

1. Confirm scope: Archive only or include install.sh changes?
2. Finalize variable list: Which ${VARS} to support?
3. Investigate stow .template handling
4. Create implementation plan for install.sh changes (if in scope)
